name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            cd /opt/lawbot
            
            REF_NAME="${{ github.ref_name }}"
            echo "üî• DETECTED BRANCH: $REF_NAME"
            
            # --- 1. –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ö–õ–Æ–ß GOOGLE (–û–ë–©–ò–ô –î–õ–Ø –í–°–ï–• –í–ï–¢–û–ö) ---
            # –ë–µ—Ä–µ–º Base64 –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ –∏ –¥–µ–∫–æ–¥–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ JSON —Ñ–∞–π–ª
            echo "üîë Restoring Google Credentials..."
            echo "${{ secrets.GOOGLE_CREDENTIALS_BASE64 }}" | base64 -d > google_credentials.json
            
            # --- –õ–û–ì–ò–ö–ê –î–õ–Ø –ü–†–û–î–ê–ö–®–ï–ù–ê (MAIN) ---
            if [[ "$REF_NAME" == "main" ]]; then
                echo "üöÄ DEPLOYING TO PRODUCTION (YANDEX)..."
                
                git fetch origin main
                git reset --hard origin/main
                
                # –°–æ–∑–¥–∞–µ–º .env (–ë–æ–µ–≤–æ–π)
                echo "STORAGE_PROVIDER=yandex" > .env
                echo "YANDEX_DISK_TOKEN=${{ secrets.YANDEX_DISK_TOKEN }}" >> .env
                
                # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª—é—á–∏
                echo "OPENAI_API_KEY=${{ secrets.OPENAI_KEY }}" >> .env
                echo "TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_SID }}" >> .env
                echo "TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_TOKEN }}" >> .env
                
                echo "ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}" >> .env
                echo "ADMIN_PASSWORD_HASH=${{ secrets.ADMIN_PASSWORD_HASH }}" >> .env
                echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env

                # –ü–û–î–ö–õ–Æ–ß–ê–ï–ú GOOGLE VISION
                echo "GOOGLE_APPLICATION_CREDENTIALS=/app/google_credentials.json" >> .env
                
                # –ó–∞–ø—É—Å–∫ –ü—Ä–æ–¥–∞
                docker-compose -p lawbot_prod up -d --build --remove-orphans
                
            # --- –õ–û–ì–ò–ö–ê –î–õ–Ø –¢–ï–°–¢–ê (DEVELOP) ---
            elif [[ "$REF_NAME" == "develop" ]]; then
                echo "üß™ DEPLOYING TO TEST (DROPBOX)..."
                
                git fetch origin develop
                git reset --hard origin/develop
                
                # –°–æ–∑–¥–∞–µ–º .env.test (–¢–µ—Å—Ç–æ–≤—ã–π)
                echo "STORAGE_PROVIDER=dropbox" > .env.test
                echo "DROPBOX_TOKEN=${{ secrets.DROPBOX_TOKEN }}" >> .env.test
                
                echo "OPENAI_API_KEY=${{ secrets.OPENAI_KEY }}" >> .env.test
                echo "TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_SID }}" >> .env.test
                echo "TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_TOKEN }}" >> .env.test
                
                echo "ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}" >> .env.test
                echo "ADMIN_PASSWORD_HASH=${{ secrets.ADMIN_PASSWORD_HASH }}" >> .env.test
                echo "SECRET_KEY=${{ secrets.SECRET_KEY }}_test" >> .env.test

                # –ü–û–î–ö–õ–Æ–ß–ê–ï–ú GOOGLE VISION –ò –¢–£–¢ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                echo "GOOGLE_APPLICATION_CREDENTIALS=/app/google_credentials.json" >> .env.test
                
                # –ó–∞–ø—É—Å–∫ –¢–µ—Å—Ç–∞
                docker-compose -p lawbot_test -f docker-compose.test.yml --env-file .env.test up -d --build --remove-orphans
            fi
            
            # –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
            docker system prune -f
            echo "‚úÖ DEPLOY COMPLETE"