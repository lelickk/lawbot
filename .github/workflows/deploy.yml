name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            cd /opt/lawbot
            
            REF_NAME="${{ github.ref_name }}"
            echo "üî• DETECTED BRANCH: $REF_NAME"
            
            if [[ "$REF_NAME" == "main" ]]; then
                echo "üöÄ DEPLOYING TO PRODUCTION (YANDEX)..."
                
                git fetch origin main
                git reset --hard origin/main
                
                # .env –¥–ª—è –ü—Ä–æ–¥–∞
                echo "STORAGE_PROVIDER=yandex" > .env
                echo "YANDEX_DISK_TOKEN=${{ secrets.YANDEX_DISK_TOKEN }}" >> .env
                echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
                echo "TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}" >> .env
                echo "TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}" >> .env
                echo "ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}" >> .env
                echo "ADMIN_PASSWORD_HASH=${{ secrets.ADMIN_PASSWORD_HASH }}" >> .env
                echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
                
                # --- –í–ê–ñ–ù–û: –î–æ–±–∞–≤–∏–ª–∏ -p lawbot_prod ---
                docker-compose -p lawbot_prod up -d --build --remove-orphans
                
            elif [[ "$REF_NAME" == "develop" ]]; then
                echo "üß™ DEPLOYING TO TEST (DROPBOX)..."
                
                git fetch origin develop
                git reset --hard origin/develop
                
                # .env.test –¥–ª—è –¢–µ—Å—Ç–∞
                echo "STORAGE_PROVIDER=dropbox" > .env.test
                echo "DROPBOX_TOKEN=${{ secrets.DROPBOX_TOKEN }}" >> .env.test
                echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env.test
                echo "TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}" >> .env.test
                echo "TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}" >> .env.test
                echo "ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}" >> .env.test
                echo "ADMIN_PASSWORD_HASH=${{ secrets.ADMIN_PASSWORD_HASH }}" >> .env.test
                echo "SECRET_KEY=${{ secrets.SECRET_KEY }}_test" >> .env.test
                
                # --- –í–ê–ñ–ù–û: –î–æ–±–∞–≤–∏–ª–∏ -p lawbot_test ---
                docker-compose -p lawbot_test -f docker-compose.test.yml up -d --build --remove-orphans
            fi
            
            docker system prune -f
            echo "‚úÖ DEPLOY COMPLETE"