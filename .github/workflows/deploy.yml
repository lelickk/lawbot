name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            cd /opt/lawbot
            
            REF_NAME="${{ github.ref_name }}"
            echo "üî• DETECTED BRANCH: $REF_NAME"
            
            # --- –õ–û–ì–ò–ö–ê –î–õ–Ø –ü–†–û–î–ê–ö–®–ï–ù–ê (MAIN) ---
            if [[ "$REF_NAME" == "main" ]]; then
                echo "üöÄ DEPLOYING TO PRODUCTION (YANDEX)..."
                
                git fetch origin main
                git reset --hard origin/main
                
                # –°–æ–∑–¥–∞–µ–º .env (–ë–æ–µ–≤–æ–π)
                # –°–õ–ï–í–ê: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è python-–∫–æ–¥–∞
                # –°–ü–†–ê–í–ê: –∏–º–µ–Ω–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ –∏–∑ —Ç–≤–æ–µ–≥–æ GitHub
                echo "STORAGE_PROVIDER=yandex" > .env
                echo "YANDEX_DISK_TOKEN=${{ secrets.YANDEX_DISK_TOKEN }}" >> .env
                
                # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∏–º–µ–Ω–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤:
                echo "OPENAI_API_KEY=${{ secrets.OPENAI_KEY }}" >> .env
                echo "TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_SID }}" >> .env
                echo "TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_TOKEN }}" >> .env
                
                echo "ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}" >> .env
                echo "ADMIN_PASSWORD_HASH=${{ secrets.ADMIN_PASSWORD_HASH }}" >> .env
                echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
                
                # –ó–∞–ø—É—Å–∫ –ü—Ä–æ–¥–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç .env –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
                docker-compose -p lawbot_prod up -d --build --remove-orphans
                
            # --- –õ–û–ì–ò–ö–ê –î–õ–Ø –¢–ï–°–¢–ê (DEVELOP) ---
            elif [[ "$REF_NAME" == "develop" ]]; then
                echo "üß™ DEPLOYING TO TEST (DROPBOX)..."
                
                git fetch origin develop
                git reset --hard origin/develop
                
                # –°–æ–∑–¥–∞–µ–º .env.test (–¢–µ—Å—Ç–æ–≤—ã–π)
                echo "STORAGE_PROVIDER=dropbox" > .env.test
                echo "DROPBOX_TOKEN=${{ secrets.DROPBOX_TOKEN }}" >> .env.test
                
                # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∏–º–µ–Ω–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤:
                echo "OPENAI_API_KEY=${{ secrets.OPENAI_KEY }}" >> .env.test
                echo "TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_SID }}" >> .env.test
                echo "TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_TOKEN }}" >> .env.test
                
                echo "ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}" >> .env.test
                echo "ADMIN_PASSWORD_HASH=${{ secrets.ADMIN_PASSWORD_HASH }}" >> .env.test
                echo "SECRET_KEY=${{ secrets.SECRET_KEY }}_test" >> .env.test
                
                # –ó–∞–ø—É—Å–∫ –¢–µ—Å—Ç–∞ (–Ø–í–ù–û —É–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ --env-file)
                docker-compose -p lawbot_test -f docker-compose.test.yml --env-file .env.test up -d --build --remove-orphans
            fi
            
            # –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã, —á—Ç–æ–±—ã –Ω–µ –∑–∞–±–∏—Ç—å –¥–∏—Å–∫
            docker system prune -f
            echo "‚úÖ DEPLOY COMPLETE"