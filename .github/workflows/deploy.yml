name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            cd /opt/lawbot
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ç–µ–∫—É—â–µ–π –≤–µ—Ç–∫–∏
            # GitHub Actions checkout —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ detached HEAD, –ø–æ—ç—Ç–æ–º—É –±–µ—Ä–µ–º –∏–∑ ref
            REF_NAME="${{ github.ref_name }}"
            echo "üî• DETECTED BRANCH: $REF_NAME"
            
            if [[ "$REF_NAME" == "main" ]]; then
                echo "üöÄ DEPLOYING TO PRODUCTION (YANDEX)..."
                
                # 1. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
                git fetch origin main
                git reset --hard origin/main
                
                # 2. –ü–∏—à–µ–º .env –¥–ª—è –ü–†–û–î–ê
                echo "Creating Production .env..."
                echo "STORAGE_PROVIDER=yandex" > .env
                echo "YANDEX_DISK_TOKEN=${{ secrets.YANDEX_DISK_TOKEN }}" >> .env
                echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
                echo "TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}" >> .env
                echo "TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}" >> .env
                echo "ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}" >> .env
                echo "ADMIN_PASSWORD_HASH=${{ secrets.ADMIN_PASSWORD_HASH }}" >> .env
                echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
                
                # 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ü–†–û–î–ê
                docker-compose up -d --build --remove-orphans
                
            elif [[ "$REF_NAME" == "develop" ]]; then
                echo "üß™ DEPLOYING TO TEST (DROPBOX)..."
                
                # 1. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
                git fetch origin develop
                git reset --hard origin/develop
                
                # 2. –ü–∏—à–µ–º .env.test –¥–ª—è –¢–ï–°–¢–ê
                echo "Creating Test .env.test..."
                echo "STORAGE_PROVIDER=dropbox" > .env.test
                echo "DROPBOX_TOKEN=${{ secrets.DROPBOX_TOKEN }}" >> .env.test
                echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env.test
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ –∫–ª—é—á–∏ Twilio (–∏–ª–∏ –¥—Ä—É–≥–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å)
                echo "TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}" >> .env.test
                echo "TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}" >> .env.test
                echo "ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}" >> .env.test
                echo "ADMIN_PASSWORD_HASH=${{ secrets.ADMIN_PASSWORD_HASH }}" >> .env.test
                echo "SECRET_KEY=${{ secrets.SECRET_KEY }}_test" >> .env.test
                
                # 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –¢–ï–°–¢–ê
                docker-compose -f docker-compose.test.yml up -d --build --remove-orphans
            fi
            
            docker system prune -f
            echo "‚úÖ DEPLOY COMPLETE"